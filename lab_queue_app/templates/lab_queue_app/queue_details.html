{% extends 'lab_queue_app/base.html' %}

{% block title %}{{ work.subject.name }} - Очередь{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h1 class="card-title h3 mb-4">{{ work.subject.name }}</h1>
                    
                    <div class="mb-4">
                        <h5 class="text-muted mb-3">Активные участники</h5>
                        {% if active_participants %}
                            <div class="list-group list-group-flush">
                                {% for participant in active_participants %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <span class="badge bg-primary me-2">#{{ participant.list_position }}</span>
                                                {{ participant.user.get_full_name|default:participant.user.username }}
                                                <span class="text-muted ms-2">
                                                    (Лаба {{ participant.practical_work.sequence_number }} - {{ participant.practical_work.name }})
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">В очереди пока никого нет</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-4">Информация об очереди</h5>
                    
                    <div class="mb-3">
                        <p class="mb-1"><strong>Предмет:</strong></p>
                        <p class="text-muted">{{ work.subject.name }}</p>
                    </div>

                    <div class="mb-3">
                        <p class="mb-1"><strong>Ваша позиция:</strong></p>
                        <p class="text-muted">
                            {% if is_in_queue %}
                                {% if user_position == 1 %}
                                    Вы первый в очереди
                                {% else %}
                                    {{ user_position|add:"-1" }} человек перед вами
                                {% endif %}
                            {% else %}
                                Вы не в очереди
                            {% endif %}
                        </p>
                    </div>

                    {% if user.is_authenticated %}
                        {% if is_in_queue %}
                            <div class="mt-4">
                                <button type="button" class="btn btn-danger w-100" onclick="openLeaveModal({{ work.id }}, '{{ work.sequence_number }} {{ work.name }}')">
                                    <i class="fas fa-sign-out-alt"></i> Выйти из очереди
                                </button>
                            </div>
                        {% else %}
                            <button type="button" class="btn btn-success w-100" onclick="openJoinModal({{ work.id }}, '{{ work.sequence_number }} {{ work.name }}', '{{ work.id }}|{{ work.sequence_number }}|{{ work.name }}')">
                                <i class="fas fa-sign-in-alt"></i> Встать в очередь
                            </button>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'login' %}" class="btn btn-primary w-100">
                            <i class="fas fa-sign-in-alt"></i> Войти для участия
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для вставания в очередь -->
<div id="joinModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
    <div style="background:white; padding:20px; margin:15% auto; width:300px; border-radius:5px;">
        <h3>Подтверждение</h3>
        <form id="joinForm" method="post">
            {% csrf_token %}
            <p>Выберите лабораторную работу:</p>
            <select name="work_id" id="joinWorkId">
                <option value="" disabled selected>Выберите лабу</option>
            </select>
            <br>
            <button type="submit" class="btn btn-success mt-3">Подтвердить</button>
            <button type="button" class="btn btn-secondary mt-3" onclick="closeJoinModal()">Отмена</button>
        </form>
    </div>
</div>

<!-- Модальное окно для выхода из очереди -->
<div id="leaveModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
    <div style="background:white; padding:20px; margin:15% auto; width:300px; border-radius:5px;">
        <h3>Подтверждение выхода</h3>
        <form id="leaveForm" method="post">
            {% csrf_token %}
            <p>Вы выходите из очереди на лабу: <span id="leaveLabName"></span></p>
            <input type="hidden" name="work_id" id="leaveWorkId">
            <label><input type="checkbox" name="has_passed" checked> Я сдал лабу</label>
            <br>
            <button type="submit" class="btn btn-danger mt-3">Подтвердить</button>
            <button type="button" class="btn btn-secondary mt-3" onclick="closeLeaveModal()">Отмена</button>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const leaveForm = document.getElementById('leaveForm');
    const joinForm = document.getElementById('joinForm');
    
    if (leaveForm) {
        leaveForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new FormData(this)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Получаем URL предыдущей страницы из document.referrer
                    const previousPage = document.referrer;
                    if (previousPage) {
                        window.location.href = previousPage;
                    } else {
                        window.location.href = '/'; // Если нет предыдущей страницы, идем на главную
                    }
                } else {
                    alert(data.error || 'Произошла ошибка при выходе из очереди');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при выходе из очереди');
            });
        });
    }

    if (joinForm) {
        joinForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new FormData(this)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.error || 'Произошла ошибка при вставании в очередь');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Произошла ошибка при вставании в очередь');
            });
        });
    }

    // Функция для обновления списка участников
    function updateParticipantsList() {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newList = doc.querySelector('.list-group');
                const currentList = document.querySelector('.list-group');
                if (newList && currentList) {
                    currentList.innerHTML = newList.innerHTML;
                }
            });
    }

    // Обновляем список каждые 5 секунд
    setInterval(updateParticipantsList, 5000);
});

function openJoinModal(workId, defaultLabName, availableWorks) {
    document.getElementById('joinModal').style.display = 'block';
    const select = document.getElementById('joinWorkId');
    select.innerHTML = '<option value="" disabled selected>Выберите лабу</option>';
    
    const works = availableWorks.split(',').map(workStr => {
        const parts = workStr.split('|').map(s => s.trim());
        if (parts.length === 3 && parts[0] && parts[1] && parts[2]) {
            return { id: parts[0], name: `${parts[1]} | ${parts[2]}` };
        }
        return null;
    }).filter(Boolean);

    works.forEach((work, idx) => {
        const option = document.createElement('option');
        option.value = work.id;
        option.text = work.name;
        if (idx === 0) option.selected = true;
        select.appendChild(option);
    });
    
    document.getElementById('joinForm').action = "{% url 'join_queue' 0 %}".replace('0', works[0].id);
}

function closeJoinModal() {
    document.getElementById('joinModal').style.display = 'none';
}

function openLeaveModal(workId, labName) {
    document.getElementById('leaveModal').style.display = 'block';
    document.getElementById('leaveLabName').innerText = labName;
    document.getElementById('leaveWorkId').value = workId;
    document.getElementById('leaveForm').action = "{% url 'leave_queue' 0 %}".replace('0', workId);
    const hasPassedCheckbox = document.querySelector('#leaveForm [name="has_passed"]');
    hasPassedCheckbox.checked = true;
}

function closeLeaveModal() {
    document.getElementById('leaveModal').style.display = 'none';
}
</script>
{% endblock %}
{% endblock %} 