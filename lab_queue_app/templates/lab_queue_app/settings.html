{% extends "lab_queue_app/base.html" %}
{% load static %}

{% block content %}
<h1>Настройки</h1>

{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
{% endif %}

<form method="post">
    {% csrf_token %}

    <!-- ===== Раздел: Обучение и очереди ===== -->
    <div>
        <h3>Обучение и очереди</h3>
        <p>Текущая учебная группа: 
            {% if user_study_group %}
                {{ user_study_group.study_group.name }}
            {% else %}
                Не выбрана
            {% endif %}
        </p>
        
        <label for="study_group_input">Изменить учебную группу:</label><br>
        <input type="text" id="study_group_input" name="study_group_name"
               placeholder="Например: KI23-13B" autocomplete="off">

        <select id="study_group_select" size="5">
            {% for group in study_groups %}
                <option value="{{ group.name }}" data-id="{{ group.id }}">{{ group.name }}</option>
            {% endfor %}
        </select>

        <input type="hidden" name="study_group" id="study_group_hidden">

        <br><br>

        <label for="subjects_select">Предметы (будут отображаться позже):</label><br>
        <select id="subjects_select" name="subjects" multiple disabled>
            {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
            {% endfor %}
        </select>
    </div>

    <br>

    <!-- ===== Раздел: Уведомления ===== -->
    <div class="notifications-settings">
        <h3>Уведомления</h3>
        
        <!-- Основные переключатели для каналов уведомлений -->
        <div class="notification-channels mb-4">
            <label class="d-block mb-2">
                <input type="checkbox" name="browser_notifications" {% if profile.browser_notifications %}checked{% endif %}>
                Браузерные уведомления
            </label>
            <label class="d-block">
                <input type="checkbox" name="telegram_notifications" {% if profile.telegram_notifications %}checked{% endif %} {% if not profile.telegram_id %}disabled{% endif %}>
                Уведомления в Telegram
            </label>
        </div>

        <!-- Детальные настройки уведомлений -->
        <div class="notification-details">
            <h4>Настройка типов уведомлений</h4>
            
            <div class="row">
                <!-- Браузерные уведомления -->
                <div class="col-md-6">
                    <h5>Браузерные уведомления</h5>
                    <div class="notification-options">
                        <label class="d-block">
                            <input type="checkbox" name="browser_queue_join_leave" {% if profile.browser_queue_join_leave %}checked{% endif %}>
                            Вход/выход из очереди
                        </label>
                        <label class="d-block">
                            <input type="checkbox" name="browser_position_change" {% if profile.browser_position_change %}checked{% endif %}>
                            Изменение позиции в очереди
                        </label>
                        <label class="d-block">
                            <input type="checkbox" name="browser_position_3_2" {% if profile.browser_position_3_2 %}checked{% endif %}>
                            Достижение 3-й и 2-й позиции
                        </label>
                        <label class="d-block">
                            <input type="checkbox" name="browser_position_1" {% if profile.browser_position_1 %}checked{% endif %}>
                            Достижение 1-й позиции
                        </label>
                    </div>
                </div>

                <!-- Telegram уведомления -->
                <div class="col-md-6">
                    <h5>Telegram уведомления</h5>
                    <div class="notification-options">
                        <label class="d-block">
                            <input type="checkbox" name="telegram_queue_join_leave" {% if profile.telegram_queue_join_leave %}checked{% endif %} {% if not profile.telegram_id %}disabled{% endif %}>
                            Вход/выход из очереди
                        </label>
                        <label class="d-block">
                            <input type="checkbox" name="telegram_position_change" {% if profile.telegram_position_change %}checked{% endif %} {% if not profile.telegram_id %}disabled{% endif %}>
                            Изменение позиции в очереди
                        </label>
                        <label class="d-block">
                            <input type="checkbox" name="telegram_position_3_2" {% if profile.telegram_position_3_2 %}checked{% endif %} {% if not profile.telegram_id %}disabled{% endif %}>
                            Достижение 3-й и 2-й позиции
                        </label>
                        <label class="d-block">
                            <input type="checkbox" name="telegram_position_1" {% if profile.telegram_position_1 %}checked{% endif %} {% if not profile.telegram_id %}disabled{% endif %}>
                            Достижение 1-й позиции
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <br>

    <!-- ===== Раздел: Безопасность ===== -->
    <div>
        <h3>Безопасность</h3>

        <div>
            <label>Текущий email: {{ user.email }}</label>
            <a href="{% url 'change_email' %}" class="btn btn-primary" style="margin-left:10px;">Сменить email</a>
        </div>

        <div>
            {% if profile.telegram_id %}
                <p><strong>Telegram ID:</strong> {{ profile.telegram_id }}</p>
                <a href="{% url 'telegram_unlink_request' %}" class="btn btn-danger">Отвязать Telegram</a>
            {% else %}
                <p><strong>Telegram:</strong> Не привязан</p>
                <a href="{% url 'telegram_link_request' %}" class="btn btn-primary">Привязать Telegram</a>
            {% endif %}
        </div>

        <br>
        <a href="{% url 'password_reset_request' %}">Сбросить пароль</a>
    </div>

    <br><br>
    <button type="submit">Сохранить изменения</button>
</form>

<!-- ===== JS: Фильтрация групп ===== -->
<script>
    const input = document.getElementById("study_group_input");
    const select = document.getElementById("study_group_select");
    const hidden = document.getElementById("study_group_hidden");

    function normalize(str) {
        return str.toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/gi, '');
    }

    function filterOptions() {
        const filter = normalize(input.value);
        let anyVisible = false;
        for (let option of select.options) {
            const match = normalize(option.text).includes(filter);
            option.hidden = !match;
            if (match) anyVisible = true;
        }
        select.style.display = anyVisible ? 'block' : 'none';
    }

    input.addEventListener("focus", () => {
        for (let option of select.options) {
            option.hidden = false;
        }
        select.style.display = 'block';
    });

    input.addEventListener("input", filterOptions);

    select.addEventListener("change", function () {
        input.value = select.value;
        hidden.value = select.selectedOptions[0].getAttribute('data-id') || '';
    });

    input.addEventListener("blur", function () {
        setTimeout(() => select.style.display = 'none', 200);
        for (let option of select.options) {
            if (option.value === input.value) {
                hidden.value = option.getAttribute('data-id') || '';
            }
        }
    });
</script>
{% endblock %}