{% extends 'lab_queue_app/base.html' %}
{% block title %}Кабинет{% endblock %}
{% block content %}
    <h2>Кабинет пользователя</h2>

    {% if no_study_group %}
        <p>Вы не выбрали учебную группу. Пожалуйста, выберите группу в <a href="{% url 'settings' %}">настройках</a>.</p>
    {% else %}
        <!-- Секция: Мои данные -->
        <h3>Мои данные</h3>
        {% if profile.avatar %}
            <img src="{{ profile.avatar.image.url }}" alt="Аватар" style="max-width: 100px;">
        {% else %}
            <p>Аватар отсутствует</p>
        {% endif %}
        <p>Имя: {{ request.user.username }}</p>
        <p>Email: {{ request.user.email|default:'Не указан' }}</p>
        <p>Telegram: {{ profile.telegram_id|default:'Не привязан' }}</p>
        <p>Учебная группа: {{ study_group.name }}</p>
        <p><a href="{% url 'settings' %}">Редактировать настройки</a></p>

        <!-- Секция: Мои предметы -->
        <h3>Мои предметы</h3>
        {% if subjects %}
            <ul>
                {% for subject in subjects %}
                    <li>{{ subject.name }}
                        <ul>
                            {% for entry in practical_works_with_status %}
                                {% if entry.work.subject == subject %}
                                    <li>
                                        {{ entry.work.name }} (Порядковый номер: {{ entry.work.sequence_number }})
                                        <a href="{{ entry.work.ekurs_link }}" target="_blank">Ссылка на eKurs</a>
                                        <!-- Кнопка "Встать в очередь" -->
                                        <button onclick="openJoinModal({{ entry.work.id }}, '{{ entry.work.sequence_number }} | {{ entry.work.name }}', '{{ entry.available_works|join:', ' }}')">
                                            Встать в очередь
                                        </button>
                                        <!-- Кнопка "Отметить сданной/несданной" -->
                                        <form method="post" action="{% if entry.is_served %}{% url 'cancel_served' entry.work.id %}{% else %}{% url 'mark_served' entry.work.id %}{% endif %}" style="display:inline;">
                                            {% csrf_token %}
                                            <button type="submit">
                                                {% if entry.is_served %}Отметить лабу несданной{% else %}Отметить лабу сданной{% endif %}
                                            </button>
                                        </form>
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>У вас нет предметов. Обратитесь к администратору, чтобы добавить предметы для вашей группы.</p>
        {% endif %}

        <!-- Секция: Мои очереди -->
        <h3>Мои очереди</h3>
        {% if user_works %}
            <ul>
                {% for entry in user_works %}
                    <li>
                        <div>
                            {{ entry.work.practical_work.subject.name }} - Лаба {{ entry.work.practical_work.sequence_number }} - 
                            Позиция: {{ entry.work.list_position }} - 
                            {% if entry.slot.is_running %}
                                Пара идёт
                            {% else %}
                                {% if entry.slot.start_datetime %}
                                    {{ entry.slot.start_datetime|date:"d.m.Y H:i" }}
                                {% else %}
                                    Нет расписания
                                {% endif %}
                            {% endif %}
                            ({{ entry.status_text }})
                            <!-- Кнопка "Выйти из очереди" -->
                            <button onclick="openLeaveModal({{ entry.work.practical_work.id }}, '{{ entry.work.practical_work.sequence_number }} {{ entry.work.practical_work.name }}')">
                                Выйти из очереди
                            </button>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Вы не записаны в очереди.</p>
        {% endif %}

        <!-- Секция: Карточки вставания в очередь -->
        <h3>Встать в очередь</h3>
        {% if queue_cards %}
            <ul>
                {% for card in queue_cards %}
                    <li>
                        {{ card.subject.name }} - Следующая лаба: {{ card.first_work_seq }}
                        <button onclick="openJoinModal({{ card.first_work_id }}, '{{ card.first_work_seq }} | {{ card.first_work_name }}', '{{ card.available_works|join:', ' }}')">
                            Встать в очередь
                        </button>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Нет доступных предметов для записи в очередь.</p>
        {% endif %}

        <!-- Секция: Расписание -->
        <h3>Расписание</h3>
        {% if slots %}
            <ul>
                {% for slot in slots %}
                    <li>
                        {{ slot.subject.name }} - {{ slot.weekday.name }} ({{ slot.week_type }} неделя) - 
                        {{ slot.start_time }} - {{ slot.end_time }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Нет доступных слотов. Обратитесь к администратору, чтобы добавить расписание.</p>
        {% endif %}
    {% endif %}

    <!-- Модальное окно для вставания в очередь -->
    <div id="joinModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
        <div style="background:white; padding:20px; margin:15% auto; width:300px; border-radius:5px;">
            <h3>Подтверждение</h3>
            <form id="joinForm" method="post">
                {% csrf_token %}
                <p>Выберите лабораторную работу:</p>
                <select name="work_id" id="joinWorkId">
                    <option value="" disabled selected>Выберите лабу</option>
                </select>
                <label><input type="checkbox" name="is_hurry" id="isHurry"> Я тороплюсь</label>
                <br>
                <button type="submit">Подтвердить</button>
                <button type="button" onclick="closeJoinModal()">Отмена</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно для выхода из очереди -->
    <div id="leaveModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
        <div style="background:white; padding:20px; margin:15% auto; width:300px; border-radius:5px;">
            <h3>Подтверждение выхода</h3>
            <form id="leaveForm" method="post">
                {% csrf_token %}
                <p>Вы выходите из очереди на лабу: <span id="leaveLabName"></span></p>
                <input type="hidden" name="work_id" id="leaveWorkId">
                <label><input type="checkbox" name="has_passed" checked> Я сдал лабу</label>
                <br>
                <button type="submit">Подтвердить</button>
                <button type="button" onclick="closeLeaveModal()">Отмена</button>
            </form>
        </div>
    </div>

    <script>
        function openJoinModal(workId, defaultLabName, availableWorks) {
            document.getElementById('joinModal').style.display = 'block';
            const select = document.getElementById('joinWorkId');
            select.innerHTML = '<option value="" disabled>Выберите лабу</option>';
            const works = availableWorks.split(', ').map(workStr => {
                const [id, seqNum, name] = workStr.split('|').map(s => s.trim());
                return { id: id, name: `${seqNum} | ${name}` };
            });
            works.forEach(work => {
                const option = document.createElement('option');
                option.value = work.id;
                option.text = work.name;
                if (work.id == workId) option.selected = true; // Устанавливаем дефолтное значение
                select.appendChild(option);
            });
            document.getElementById('joinForm').action = "{% url 'join_queue' 0 %}".replace('0', workId);
        }

        function closeJoinModal() {
            document.getElementById('joinModal').style.display = 'none';
            document.getElementById('isHurry').checked = false;
        }

        function openLeaveModal(workId, labName) {
            document.getElementById('leaveModal').style.display = 'block';
            document.getElementById('leaveLabName').innerText = labName;
            document.getElementById('leaveWorkId').value = workId;
            document.getElementById('leaveForm').action = "{% url 'leave_queue' 0 %}".replace('0', workId);
        }

        function closeLeaveModal() {
            document.getElementById('leaveModal').style.display = 'none';
        }
    </script>
{% endblock %}