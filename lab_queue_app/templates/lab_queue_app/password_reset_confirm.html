{% extends 'lab_queue_app/base.html' %}
{% load static %}

{% block title %}Установка нового пароля{% endblock %}
{% block content %}
    <h2>Установка нового пароля</h2>
    {% if validlink %}
        {% if form.non_field_errors %}
            <div class="errorlist">{{ form.non_field_errors }}</div>
        {% endif %}
        <form method="post" id="passwordForm" novalidate>
            {% csrf_token %}
            <div class="form-group">
                {{ form.password1.label_tag }}
                <input type="password" name="password1" id="id_password1" minlength="8" required>
                <div class="password-strength">
                    <div class="strength-meter">
                        <div class="strength-meter-fill" data-strength="0"></div>
                    </div>
                    <div class="strength-text">Введите пароль</div>
                </div>
                <div class="password-requirements">
                    <p>Пароль должен содержать:</p>
                    <ul>
                        <li id="length">Минимум 8 символов</li>
                        <li id="uppercase">Заглавную букву</li>
                        <li id="lowercase">Строчную букву</li>
                        <li id="number">Цифру</li>
                        <li id="special">Специальный символ (!@#$%^&*)</li>
                    </ul>
                </div>
                <div class="error" id="password1Error"></div>
                {% if form.password1.errors %}
                    <div class="errorlist">{{ form.password1.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.password2.label_tag }}
                <input type="password" name="password2" id="id_password2" minlength="8" required>
                <div class="error" id="password2Error"></div>
                {% if form.password2.errors %}
                    <div class="errorlist">{{ form.password2.errors }}</div>
                {% endif %}
            </div>

            <button type="submit" class="btn btn-primary">Сохранить пароль</button>
        </form>

        <link rel="stylesheet" href="{% static 'css/password_strength.css' %}">
        <script src="{% static 'js/password_strength.js' %}"></script>
        <style>
            .password-strength {
                margin-top: 10px;
            }
            .strength-meter {
                height: 5px;
                background-color: #ddd;
                border-radius: 3px;
                margin-bottom: 5px;
            }
            .strength-meter-fill {
                height: 100%;
                border-radius: 3px;
                transition: width 0.3s ease-in-out;
                width: 0;
            }
            .strength-meter-fill[data-strength="0"] { width: 0; background-color: #ddd; }
            .strength-meter-fill[data-strength="1"] { width: 25%; background-color: #ff4d4d; }
            .strength-meter-fill[data-strength="2"] { width: 50%; background-color: #ffa64d; }
            .strength-meter-fill[data-strength="3"] { width: 75%; background-color: #4dff4d; }
            .strength-meter-fill[data-strength="4"] { width: 100%; background-color: #00cc00; }
            .strength-text {
                font-size: 0.9em;
                color: #666;
            }
            .password-requirements {
                margin-top: 10px;
                font-size: 0.9em;
                color: #666;
            }
            .password-requirements ul {
                list-style: none;
                padding-left: 0;
                margin: 5px 0;
            }
            .password-requirements li {
                margin: 3px 0;
                color: #999;
            }
            .password-requirements li.valid {
                color: #4dff4d;
            }
            .errorlist {
                color: red;
                font-size: 0.9em;
                margin-top: 5px;
            }
            .error {
                color: red;
                font-size: 0.9em;
                min-height: 20px;
            }
        </style>
        <script>
            const password1Input = document.getElementById('id_password1');
            const password2Input = document.getElementById('id_password2');
            const passwordForm = document.getElementById('passwordForm');
            const password1Error = document.getElementById('password1Error');
            const password2Error = document.getElementById('password2Error');

            function checkPasswordStrength(password) {
                let strength = 0;
                if (password.length >= 8) {
                    document.getElementById('length').classList.add('valid');
                    strength += 1;
                } else {
                    document.getElementById('length').classList.remove('valid');
                }
                if (/[A-Z]/.test(password)) {
                    document.getElementById('uppercase').classList.add('valid');
                    strength += 1;
                } else {
                    document.getElementById('uppercase').classList.remove('valid');
                }
                if (/[a-z]/.test(password)) {
                    document.getElementById('lowercase').classList.add('valid');
                    strength += 1;
                } else {
                    document.getElementById('lowercase').classList.remove('valid');
                }
                if (/[0-9]/.test(password)) {
                    document.getElementById('number').classList.add('valid');
                    strength += 1;
                } else {
                    document.getElementById('number').classList.remove('valid');
                }
                if (/[!@#$%^&*]/.test(password)) {
                    document.getElementById('special').classList.add('valid');
                    strength += 1;
                } else {
                    document.getElementById('special').classList.remove('valid');
                }
                const strengthMeter = document.querySelector('.strength-meter-fill');
                const strengthText = document.querySelector('.strength-text');
                strengthMeter.setAttribute('data-strength', strength);
                switch(strength) {
                    case 0:
                        strengthText.textContent = 'Введите пароль';
                        break;
                    case 1:
                        strengthText.textContent = 'Слабый пароль';
                        break;
                    case 2:
                        strengthText.textContent = 'Средний пароль';
                        break;
                    case 3:
                        strengthText.textContent = 'Хороший пароль';
                        break;
                    case 4:
                        strengthText.textContent = 'Отличный пароль';
                        break;
                    case 5:
                        strengthText.textContent = 'Отличный пароль';
                        break;
                }
                return strength;
            }

            function validatePasswords() {
                let isValid = true;
                const strength = checkPasswordStrength(password1Input.value);
                if (password1Input.value.length > 0 && strength < 3) {
                    password1Error.textContent = 'Пароль слишком слабый. Используйте заглавные и строчные буквы, цифры и специальные символы.';
                    isValid = false;
                } else {
                    password1Error.textContent = '';
                }
                if (password2Input.value.length > 0 && password2Input.value !== password1Input.value) {
                    password2Error.textContent = 'Пароли не совпадают.';
                    isValid = false;
                } else {
                    password2Error.textContent = '';
                }
                return isValid;
            }

            password1Input.addEventListener('input', validatePasswords);
            password2Input.addEventListener('input', validatePasswords);

            passwordForm.addEventListener('submit', function(e) {
                if (!validatePasswords()) {
                    e.preventDefault();
                }
            });
        </script>
    {% else %}
        <p style="color: red;">Ссылка недействительна или истек срок её действия.</p>
        <p><a href="{% url 'password_reset_request' %}">Запросить новую ссылку</a></p>
    {% endif %}
{% endblock %}