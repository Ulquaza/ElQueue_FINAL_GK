{% extends 'lab_queue_app/base.html' %}
{% load static %}

{% block content %}
    <h2>Регистрация</h2>
    <form method="POST" id="regForm" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="errorlist">{{ form.non_field_errors }}</div>
        {% endif %}
        <div class="form-group">
            {{ form.username.label_tag }}
            <input type="text" name="username" id="id_username" pattern="^[A-Za-z0-9.@+-]+$" minlength="3" maxlength="150" required title="Только буквы, цифры, подчёркивания, точки, @, +, -" value="{{ form.username.value|default:'' }}">
            <div class="error" id="usernameError"></div>
            {% if form.username.errors %}
                <div class="errorlist">{{ form.username.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.email.label_tag }}
            <input type="email" name="email" id="id_email" required value="{{ form.email.value|default:'' }}">
            <div class="error" id="emailError"></div>
            {% if form.email.errors %}
                <div class="errorlist">{{ form.email.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.password1.label_tag }}
            <input type="password" name="password1" id="id_password1" minlength="8" required>
            <div class="password-strength">
                <div class="strength-meter">
                    <div class="strength-meter-fill" data-strength="0"></div>
                </div>
                <div class="strength-text">Введите пароль</div>
            </div>
            <div class="password-requirements">
                <p>Пароль должен содержать:</p>
                <ul>
                    <li id="length">Минимум 8 символов</li>
                    <li id="uppercase">Заглавную букву</li>
                    <li id="lowercase">Строчную букву</li>
                    <li id="number">Цифру</li>
                    <li id="special">Специальный символ (!@#$%^&*)</li>
                </ul>
            </div>
            <div class="error" id="password1Error"></div>
            {% if form.password1.errors %}
                <div class="errorlist">{{ form.password1.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.password2.label_tag }}
            <input type="password" name="password2" id="id_password2" minlength="8" required>
            <div class="error" id="password2Error"></div>
            {% if form.password2.errors %}
                <div class="errorlist">{{ form.password2.errors }}</div>
            {% endif %}
        </div>

        {{ form.captcha }}
        {% if form.captcha.errors %}
            <div class="errorlist">{{ form.captcha.errors }}</div>
        {% endif %}

        <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
    </form>

    <link rel="stylesheet" href="{% static 'css/password_strength.css' %}">
    <script src="{% static 'js/password_strength.js' %}"></script>
    <style>
        .password-strength {
            margin-top: 10px;
        }
        .strength-meter {
            height: 5px;
            background-color: #ddd;
            border-radius: 3px;
            margin-bottom: 5px;
        }
        .strength-meter-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease-in-out;
            width: 0;
        }
        .strength-meter-fill[data-strength="0"] { width: 0; background-color: #ddd; }
        .strength-meter-fill[data-strength="1"] { width: 25%; background-color: #ff4d4d; }
        .strength-meter-fill[data-strength="2"] { width: 50%; background-color: #ffa64d; }
        .strength-meter-fill[data-strength="3"] { width: 75%; background-color: #4dff4d; }
        .strength-meter-fill[data-strength="4"] { width: 100%; background-color: #00cc00; }
        
        .strength-text {
            font-size: 0.9em;
            color: #666;
        }
        
        .password-requirements {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        
        .password-requirements ul {
            list-style: none;
            padding-left: 0;
            margin: 5px 0;
        }
        
        .password-requirements li {
            margin: 3px 0;
            color: #999;
        }
        
        .password-requirements li.valid {
            color: #4dff4d;
        }
        
        .email-hint {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
    </style>
    <script>
    const usernameInput = document.getElementById('id_username');
    const emailInput = document.getElementById('id_email');
    const password1Input = document.getElementById('id_password1');
    const password2Input = document.getElementById('id_password2');
    const regForm = document.getElementById('regForm');

    const usernameError = document.getElementById('usernameError');
    const emailError = document.getElementById('emailError');
    const password1Error = document.getElementById('password1Error');
    const password2Error = document.getElementById('password2Error');

    // Список разрешенных доменов
    const allowedDomains = [
        'gmail.com',
        'mail.ru',
        'inbox.ru',
        'list.ru',
        'bk.ru',
        'internet.ru',
        'yandex.ru',
        'ya.ru',
        'yandex.com',
        'yandex.by',
        'yandex.kz',
        'yandex.ua',
        'edu.spbstu.ru',
        'spbstu.ru',
        'outlook.com',
        'hotmail.com',
        'icloud.com',
        'me.com',
        'mac.com',
        'protonmail.com',
        'proton.me',
        'tutanota.com',
        'tutanota.de',
        'zoho.com',
        'aol.com',
        'yahoo.com',
        'rambler.ru',
        'lenta.ru',
        'autorambler.ru',
        'myrambler.ru',
        'ro.ru',
        'rambler.ua'
    ];

    usernameInput.addEventListener('input', function(e) {
        const pattern = /^[\w.@+-]+$/;
        if (!pattern.test(e.target.value) && e.target.value.length > 0) {
            usernameError.textContent = 'Только буквы, цифры, _, ., @, +, -';
        } else {
            usernameError.textContent = '';
        }
    });

    emailInput.addEventListener('input', function(e) {
        const email = e.target.value;
        const domain = email.split('@')[1];
        
        if (email.length > 0) {
            if (!e.target.checkValidity()) {
                emailError.textContent = 'Введите корректный email.';
            } else if (!allowedDomains.includes(domain)) {
                emailError.textContent = 'Используйте разрешенный домен: gmail.com, mail.ru, yandex.ru, edu.spbstu.ru';
            } else {
                emailError.textContent = '';
            }
        } else {
            emailError.textContent = '';
        }
    });

    function checkPasswordStrength(password) {
        let strength = 0;
        
        // Проверка длины
        if (password.length >= 8) {
            document.getElementById('length').classList.add('valid');
            strength += 1;
        } else {
            document.getElementById('length').classList.remove('valid');
        }
        
        // Проверка заглавных букв
        if (/[A-Z]/.test(password)) {
            document.getElementById('uppercase').classList.add('valid');
            strength += 1;
        } else {
            document.getElementById('uppercase').classList.remove('valid');
        }
        
        // Проверка строчных букв
        if (/[a-z]/.test(password)) {
            document.getElementById('lowercase').classList.add('valid');
            strength += 1;
        } else {
            document.getElementById('lowercase').classList.remove('valid');
        }
        
        // Проверка цифр
        if (/[0-9]/.test(password)) {
            document.getElementById('number').classList.add('valid');
            strength += 1;
        } else {
            document.getElementById('number').classList.remove('valid');
        }
        
        // Проверка специальных символов
        if (/[!@#$%^&*]/.test(password)) {
            document.getElementById('special').classList.add('valid');
            strength += 1;
        } else {
            document.getElementById('special').classList.remove('valid');
        }
        
        // Обновление индикатора силы пароля
        const strengthMeter = document.querySelector('.strength-meter-fill');
        const strengthText = document.querySelector('.strength-text');
        
        strengthMeter.setAttribute('data-strength', strength);
        
        switch(strength) {
            case 0:
                strengthText.textContent = 'Введите пароль';
                break;
            case 1:
                strengthText.textContent = 'Слабый пароль';
                break;
            case 2:
                strengthText.textContent = 'Средний пароль';
                break;
            case 3:
                strengthText.textContent = 'Хороший пароль';
                break;
            case 4:
                strengthText.textContent = 'Отличный пароль';
                break;
            case 5:
                strengthText.textContent = 'Отличный пароль';
                break;
        }
        
        return strength;
    }

    function validatePasswords() {
        let isValid = true;
        const strength = checkPasswordStrength(password1Input.value);
        
        if (password1Input.value.length > 0 && strength < 3) {
            password1Error.textContent = 'Пароль слишком слабый. Используйте заглавные и строчные буквы, цифры и специальные символы.';
            isValid = false;
        } else {
            password1Error.textContent = '';
        }

        if (password2Input.value.length > 0 && password2Input.value !== password1Input.value) {
            password2Error.textContent = 'Пароли не совпадают.';
            isValid = false;
        } else {
            password2Error.textContent = '';
        }
        return isValid;
    }

    password1Input.addEventListener('input', validatePasswords);
    password2Input.addEventListener('input', validatePasswords);

    regForm.addEventListener('submit', function(e) {
        const email = emailInput.value;
        const domain = email.split('@')[1];
        
        if (!validatePasswords() || 
            !usernameInput.checkValidity() || 
            !emailInput.checkValidity() || 
            !allowedDomains.includes(domain)) {
            e.preventDefault();
        }
    });
    </script>
{% endblock %}