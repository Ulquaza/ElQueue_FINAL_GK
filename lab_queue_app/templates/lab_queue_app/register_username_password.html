{% extends 'lab_queue_app/base.html' %}
{% load static %}

{% block content %}
    <h2>Регистрация</h2>
    <form method="POST" id="regForm" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
            <div class="errorlist">{{ form.non_field_errors }}</div>
        {% endif %}
        <div class="form-group">
            {{ form.username.label_tag }}
            <input type="text" name="username" id="id_username" pattern="^[A-Za-z0-9.@+-]+$" minlength="3" maxlength="150" required title="Только буквы, цифры, подчёркивания, точки, @, +, -" value="{{ form.username.value|default:'' }}">
            <div class="error" id="usernameError"></div>
            {% if form.username.errors %}
                <div class="errorlist">{{ form.username.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.email.label_tag }}
            <input type="email" name="email" id="id_email" required value="{{ form.email.value|default:'' }}">
            <div class="error" id="emailError"></div>
            {% if form.email.errors %}
                <div class="errorlist">{{ form.email.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.password1.label_tag }}
            <input type="password" name="password1" id="id_password1" minlength="8" required>
            <div class="error" id="password1Error"></div>
            {% if form.password1.errors %}
                <div class="errorlist">{{ form.password1.errors }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.password2.label_tag }}
            <input type="password" name="password2" id="id_password2" minlength="8" required>
            <div class="error" id="password2Error"></div>
            {% if form.password2.errors %}
                <div class="errorlist">{{ form.password2.errors }}</div>
            {% endif %}
        </div>

        {{ form.captcha }}
        {% if form.captcha.errors %}
            <div class="errorlist">{{ form.captcha.errors }}</div>
        {% endif %}

        <button type="submit" class="btn btn-primary">Зарегистрироваться</button>
    </form>

    <link rel="stylesheet" href="{% static 'css/password_strength.css' %}">
    <script src="{% static 'js/password_strength.js' %}"></script>
    <script>
    const usernameInput = document.getElementById('id_username');
    const emailInput = document.getElementById('id_email');
    const password1Input = document.getElementById('id_password1');
    const password2Input = document.getElementById('id_password2');
    const regForm = document.getElementById('regForm');

    const usernameError = document.getElementById('usernameError');
    const emailError = document.getElementById('emailError');
    const password1Error = document.getElementById('password1Error');
    const password2Error = document.getElementById('password2Error');

    usernameInput.addEventListener('input', function(e) {
        const pattern = /^[\w.@+-]+$/;
        if (!pattern.test(e.target.value) && e.target.value.length > 0) {
            usernameError.textContent = 'Только буквы, цифры, _, ., @, +, -';
        } else {
            usernameError.textContent = '';
        }
    });

    emailInput.addEventListener('input', function(e) {
        if (e.target.value.length > 0 && !e.target.checkValidity()) {
            emailError.textContent = 'Введите корректный email.';
        } else {
            emailError.textContent = '';
        }
    });

    function validatePasswords() {
        let isValid = true;
        if (password1Input.value.length > 0 && password1Input.value.length < 8) {
            password1Error.textContent = 'Пароль должен быть не короче 8 символов.';
            isValid = false;
        } else {
            password1Error.textContent = '';
        }

        if (password2Input.value.length > 0 && password2Input.value.length < 8) {
            password2Error.textContent = 'Пароль должен быть не короче 8 символов.';
            isValid = false;
        } else if (password1Input.value !== password2Input.value && password2Input.value.length > 0) {
            password2Error.textContent = 'Пароли не совпадают.';
            isValid = false;
        } else {
            password2Error.textContent = '';
        }
        return isValid;
    }

    password1Input.addEventListener('input', validatePasswords);
    password2Input.addEventListener('input', validatePasswords);

    regForm.addEventListener('submit', function(e) {
        if (!validatePasswords()) {
            e.preventDefault();
        }
        // Дополнительные проверки перед отправкой, если нужны
        if (!usernameInput.checkValidity() || !emailInput.checkValidity() || !password1Input.checkValidity() || !password2Input.checkValidity()){
            e.preventDefault();
            // Можно добавить общую ошибку или подсветить незаполненные поля
        }

    });
    </script>
{% endblock %}