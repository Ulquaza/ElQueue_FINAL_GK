{% extends 'lab_queue_app/base.html' %}
{% block title %}Регистрация - Подтверждение кода{% endblock %}
{% block content %}
    <h2>Регистрация - Подтверждение кода</h2>
    {% if error %}
        <p style="color: red;">{{ error }}</p>
    {% endif %}
    {% if message %}
        <p style="color: green;">{{ message }}</p>
        <p style="color: orange;">Внимание: используйте только последний полученный код! Все предыдущие коды больше не действуют.</p>
    {% endif %}
    <form method="post" id="codeForm">
        {% csrf_token %}
        <label>Email: <input type="email" name="email" value="{{ email }}" readonly></label><br>
        <label>Код подтверждения: <input type="text" name="code" required></label><br>
        <button type="submit">Продолжить</button>
    </form>
    <form method="post" id="resendForm" style="margin-top: 10px; display: none;">
        {% csrf_token %}
        <input type="hidden" name="resend" value="1">
        <button type="submit" id="resendBtn">Отправить код повторно</button>
        {% if show_captcha %}
            <div style="margin-top:10px;">{{ captcha_form.captcha }}</div>
            <script src="https://www.google.com/recaptcha/api.js" async defer></script>
        {% endif %}
    </form>
    <div id="timer" style="margin-top: 10px;"></div>
    <script>
        let secondsLeft = Number({{ seconds_left|default:0 }});
        const resendTimeout = Number({{ resend_timeout|default:60 }});
        const timerDiv = document.getElementById('timer');
        const resendForm = document.getElementById('resendForm');
        const resendBtn = document.getElementById('resendBtn');

        function updateTimer() {
            if (secondsLeft > 0) {
                resendForm.style.display = 'none';
                timerDiv.textContent = 'Повторная отправка кода будет доступна через ' + secondsLeft + ' сек.';
                secondsLeft--;
                setTimeout(updateTimer, 1000);
            } else {
                timerDiv.textContent = '';
                resendForm.style.display = '';
            }
        }
        updateTimer();
        resendForm.addEventListener('submit', function() {
            resendForm.style.display = 'none';
            timerDiv.textContent = 'Код отправлен. Подождите...';
            secondsLeft = resendTimeout;
            setTimeout(updateTimer, 1000);
        });
    </script>
{% endblock %}